---
title: "Analysis of babynames with dplyr"
output: html_notebook
---

Use dplyr syntax to write Spark SQL queries. Use select, where, group by, joins, and window functions in Spark SQL.

## Setup

```{r setup}
library(babynames)
library(dplyr)
library(ggplot2)
library(dygraphs)
library(reshape2)
library(rbokeh)
```

## Total births

Plot total US births recorded from the Social Security Administration.

```{r}
applicants %>%
  mutate(male = ifelse(sex == "M", n_all, 0), female = ifelse(sex == "F", n_all, 0)) %>%
  group_by(year) %>%
  summarize(Male = sum(male), Female = sum(female)) %>%
  dygraph(main = "Total US Births (SSN)") %>%
  dySeries("Male") %>%
  dySeries("Female") %>%
  dyOptions(stackedGraph = TRUE) %>%
  dyRangeSelector(height = 20)
```

## Top 5 names from 1986

Identify the top 5 male and female names from 1986. Visualize the popularity trend over time.

```{r}
topNames <- babynames %>%
  filter(year >= 1986) %>%  
  group_by(name, sex) %>%
  summarize(count = sum(n)) %>%
  filter(count > 1000)

filteredNames <- babynames %>%
  filter(year >= 1986) %>%
  inner_join(topNames)

yearlyNames <- filteredNames %>%
  group_by(year, name, sex) %>%
  summarize(count = sum(n))

top5Names1986 <- yearlyNames %>%
  filter(year == 1986) %>%
  group_by(name, sex) %>%
  summarize(count = sum(count)) %>%
  group_by(sex) %>%
  mutate(rank = min_rank(desc(count))) %>%
  filter(rank <= 5) %>%
  arrange(sex, rank) %>%
  select(name, sex, rank)

top5Names1986

inner_join(yearlyNames, top5Names1986) %>%
ggplot(aes(year, count, color=name)) +
  facet_grid(~sex) +
  geom_line() +
  ggtitle("Most Popular Names of 1986")
```

## Top 5 names from 2014

Identify the top 5 male and female names from 2014. Visualize the popularity trend over time.

```{r}
top5Names2014 <- yearlyNames %>%
  filter(year == 2014) %>%
  group_by(name, sex) %>%
  summarize(count = sum(count)) %>%
  group_by(sex) %>%
  mutate(rank = min_rank(desc(count))) %>%
  filter(rank <= 5) %>%
  arrange(sex, rank) %>%
  select(name, sex, rank)

inner_join(yearlyNames, top5Names2014) %>%
ggplot(aes(year, count, color=name)) +
  facet_grid(~sex) +
  geom_line() +
  ggtitle("Most Popular Names of 2014")
```

## Same names

Visualize the most popular names that are used by both males and females.

```{r}
sameName <- babynames %>%
  mutate(male = ifelse(sex == "M", n, 0), female = ifelse(sex == "F", n, 0)) %>%
  group_by(name) %>%
  summarize(Male = sum(male), Female = sum(female)) %>%
  filter(Male > 30000 & Female > 30000)

figure(width = NULL, height = NULL) %>%
  ly_points(log10(Male), log10(Female), data = sameName,
    hover = list(name, Male, Female))
```
